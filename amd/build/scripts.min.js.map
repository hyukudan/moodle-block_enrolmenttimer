{"version":3,"file":"scripts.min.js","sources":["../src/scripts.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Live countdown timer for the enrolment timer block.\n *\n * Uses stable data-unit attributes (language-independent) and wall-clock\n * timing to avoid drift from setInterval inaccuracies and tab throttling.\n *\n * @module     block_enrolmenttimer/scripts\n * @copyright  2014 onwards LearningWorks Ltd {@link https://learningworks.co.nz/}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author     Aaron Leggett\n */\ndefine(['jquery'], function($) {\n\n    return {\n        /**\n         * Initialise the countdown timer.\n         */\n        initialise: function() {\n            $(document).ready(function() {\n                var activeUnits = [];\n                var forceTwoDigits = false;\n                var intervalId = null;\n                var endTime = 0;\n\n                var unitSeconds = {\n                    'years': 31536000,\n                    'months': 2592000,\n                    'weeks': 604800,\n                    'days': 86400,\n                    'hours': 3600,\n                    'minutes': 60,\n                    'seconds': 1\n                };\n\n                /**\n                 * Find displayed time unit elements using stable data-unit attributes.\n                 */\n                function getDisplayedUnits() {\n                    var children = $('.block_enrolmenttimer .active .timer-wrapper').find('.timerNum[data-unit]');\n                    children.each(function() {\n                        activeUnits.push($(this).attr('data-unit'));\n                    });\n                }\n\n                /**\n                 * Calculate initial total seconds from text description spans using data-unit.\n                 */\n                function calculateInitialTimestamp() {\n                    var timestamp = 0;\n                    for (var i = 0; i < activeUnits.length; i++) {\n                        var unitKey = activeUnits[i];\n                        var val = parseInt(\n                            $('.block_enrolmenttimer .active .text-desc [data-unit=\"' + unitKey + '\"]').text(),\n                            10\n                        );\n                        if (!isNaN(val) && unitSeconds[unitKey]) {\n                            timestamp += val * unitSeconds[unitKey];\n                        }\n                    }\n                    return timestamp;\n                }\n\n                /**\n                 * Update a single counter element in the DOM.\n                 *\n                 * @param {string} unitKey The stable unit key (e.g. 'hours').\n                 * @param {number} time The value to display.\n                 */\n                function updateMainCounter(unitKey, time) {\n                    var html = '';\n                    var timeStr = time.toString();\n                    if (forceTwoDigits === true && timeStr.length === 1) {\n                        html += '<span class=\"timerNumChar\" data-id=\"0\">0</span>';\n                        html += '<span class=\"timerNumChar\" data-id=\"1\">' + timeStr + '</span>';\n                    } else {\n                        for (var i = 0; i < timeStr.length; i++) {\n                            html += '<span class=\"timerNumChar\" data-id=\"' + i + '\">' +\n                                timeStr.charAt(i) + '</span>';\n                        }\n                    }\n\n                    $('.block_enrolmenttimer .active .timer-wrapper .timerNum[data-unit=\"' + unitKey + '\"]')\n                        .html(html);\n                    $('.block_enrolmenttimer .active .text-desc [data-unit=\"' + unitKey + '\"]')\n                        .html(time);\n                }\n\n                /**\n                 * Calculate remaining time from wall clock and update all displayed counters.\n                 */\n                function updateLiveCounter() {\n                    var remaining = Math.max(0, Math.floor((endTime - Date.now()) / 1000));\n\n                    if (remaining <= 0) {\n                        if (intervalId !== null) {\n                            window.clearInterval(intervalId);\n                            intervalId = null;\n                        }\n                        for (var j = 0; j < activeUnits.length; j++) {\n                            updateMainCounter(activeUnits[j], 0);\n                        }\n                        return;\n                    }\n\n                    var time = remaining;\n                    var tokens = ['years', 'months', 'weeks', 'days', 'hours', 'minutes', 'seconds'];\n                    var units = [31536000, 2592000, 604800, 86400, 3600, 60, 1];\n\n                    for (var i = 0; i < tokens.length; i++) {\n                        if (activeUnits.indexOf(tokens[i]) !== -1) {\n                            var count = Math.floor(time / units[i]);\n                            updateMainCounter(tokens[i], count);\n                            time = time - (count * units[i]);\n                        }\n                    }\n                }\n\n                if ($('.block_enrolmenttimer .active').length > 0) {\n                    if ($('.block_enrolmenttimer .timer-wrapper[data-id=force2]').length > 0) {\n                        forceTwoDigits = true;\n                    }\n\n                    getDisplayedUnits();\n                    var initialSeconds = calculateInitialTimestamp();\n                    endTime = Date.now() + (initialSeconds * 1000);\n\n                    intervalId = window.setInterval(function() {\n                        updateLiveCounter();\n                    }, 1000);\n\n                    // Handle tab visibility changes to keep timer accurate.\n                    if (typeof document.addEventListener === 'function') {\n                        document.addEventListener('visibilitychange', function() {\n                            if (!document.hidden && intervalId === null && endTime > Date.now()) {\n                                intervalId = window.setInterval(function() {\n                                    updateLiveCounter();\n                                }, 1000);\n                                updateLiveCounter();\n                            }\n                        });\n                    }\n                }\n            });\n        }\n    };\n});\n"],"names":["define","$","initialise","document","ready","activeUnits","forceTwoDigits","intervalId","endTime","unitSeconds","updateMainCounter","unitKey","time","html","timeStr","toString","length","i","charAt","updateLiveCounter","remaining","Math","max","floor","Date","now","window","clearInterval","j","tokens","units","indexOf","count","find","each","push","this","attr","initialSeconds","timestamp","val","parseInt","text","isNaN","calculateInitialTimestamp","setInterval","addEventListener","hidden"],"mappings":";;;;;;;;;;;AA0BAA,sCAAO,CAAC,WAAW,SAASC,SAEjB,CAIHC,WAAY,WACRD,EAAEE,UAAUC,OAAM,eACVC,YAAc,GACdC,gBAAiB,EACjBC,WAAa,KACbC,QAAU,EAEVC,YAAc,OACL,eACC,aACD,YACD,YACC,aACE,WACA,YAqCNC,kBAAkBC,QAASC,UAC5BC,KAAO,GACPC,QAAUF,KAAKG,eACI,IAAnBT,gBAA8C,IAAnBQ,QAAQE,OACnCH,MAAQ,kDACRA,MAAQ,0CAA4CC,QAAU,mBAEzD,IAAIG,EAAI,EAAGA,EAAIH,QAAQE,OAAQC,IAChCJ,MAAQ,uCAAyCI,EAAI,KACjDH,QAAQI,OAAOD,GAAK,UAIhChB,EAAE,qEAAuEU,QAAU,MAC9EE,KAAKA,MACVZ,EAAE,wDAA0DU,QAAU,MACjEE,KAAKD,eAMLO,wBACDC,UAAYC,KAAKC,IAAI,EAAGD,KAAKE,OAAOf,QAAUgB,KAAKC,OAAS,SAE5DL,WAAa,GACM,OAAfb,aACAmB,OAAOC,cAAcpB,YACrBA,WAAa,UAEZ,IAAIqB,EAAI,EAAGA,EAAIvB,YAAYW,OAAQY,IACpClB,kBAAkBL,YAAYuB,GAAI,gBAKtChB,KAAOQ,UACPS,OAAS,CAAC,QAAS,SAAU,QAAS,OAAQ,QAAS,UAAW,WAClEC,MAAQ,CAAC,QAAU,OAAS,OAAQ,MAAO,KAAM,GAAI,GAEhDb,EAAI,EAAGA,EAAIY,OAAOb,OAAQC,QACS,IAApCZ,YAAY0B,QAAQF,OAAOZ,IAAY,KACnCe,MAAQX,KAAKE,MAAMX,KAAOkB,MAAMb,IACpCP,kBAAkBmB,OAAOZ,GAAIe,OAC7BpB,MAAeoB,MAAQF,MAAMb,OAKrChB,EAAE,iCAAiCe,OAAS,EAAG,CAC3Cf,EAAE,wDAAwDe,OAAS,IACnEV,gBAAiB,GAjFNL,EAAE,gDAAgDgC,KAAK,wBAC7DC,MAAK,WACV7B,YAAY8B,KAAKlC,EAAEmC,MAAMC,KAAK,qBAmF9BC,kCA3EAC,UAAY,EACPtB,EAAI,EAAGA,EAAIZ,YAAYW,OAAQC,IAAK,KACrCN,QAAUN,YAAYY,GACtBuB,IAAMC,SACNxC,EAAE,wDAA0DU,QAAU,MAAM+B,OAC5E,KAECC,MAAMH,MAAQ/B,YAAYE,WAC3B4B,WAAaC,IAAM/B,YAAYE,iBAGhC4B,UAgEcK,GACrBpC,QAAUgB,KAAKC,MAA0B,IAAjBa,eAExB/B,WAAamB,OAAOmB,aAAY,WAC5B1B,sBACD,KAGsC,mBAA9BhB,SAAS2C,kBAChB3C,SAAS2C,iBAAiB,oBAAoB,YACrC3C,SAAS4C,QAAyB,OAAfxC,YAAuBC,QAAUgB,KAAKC,QAC1DlB,WAAamB,OAAOmB,aAAY,WAC5B1B,sBACD,KACHA"}