{"version":3,"file":"scripts.min.js","sources":["../src/scripts.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Live countdown timer for the enrolment timer block.\n *\n * @module     block_enrolmenttimer/scripts\n * @copyright  2014 onwards LearningWorks Ltd {@link https://learningworks.co.nz/}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author     Aaron Leggett\n */\ndefine(['jquery'], function($) {\n\n    return {\n        /**\n         * Initialise the countdown timer.\n         */\n        initialise: function() {\n            $(document).ready(function() {\n                var options = [];\n                var arrayKeys = [];\n                var timestamp = 0;\n                var forceTwoDigits = false;\n                var intervalId = null;\n\n                /**\n                 * Find displayed time unit elements and extract their data-id keys.\n                 */\n                function getDisplayedOptions() {\n                    var children = $('.block_enrolmenttimer .active .timer-wrapper').find('.timerNum');\n\n                    for (var i = children.length - 1; i >= 0; i--) {\n                        var arrayKey = $(children[i]).attr('data-id');\n                        arrayKeys.push(arrayKey);\n                    }\n                }\n\n                /**\n                 * Read the initial values from the text description elements.\n                 */\n                function populateWithData() {\n                    for (var i = arrayKeys.length - 1; i >= 0; i--) {\n                        var option = $('.block_enrolmenttimer .active .text-desc .' + arrayKeys[i]).text();\n                        options[arrayKeys[i]] = option;\n                    }\n                }\n\n                /**\n                 * Convert displayed unit values into a total timestamp in seconds.\n                 */\n                function makeTimestamp() {\n                    var unitSeconds = {\n                        'seconds': 1,\n                        'minutes': 60,\n                        'hours': 3600,\n                        'days': 86400,\n                        'weeks': 604800,\n                        'months': 2592000,\n                        'years': 31536000\n                    };\n\n                    for (var i = 0; i < arrayKeys.length; i++) {\n                        var val = parseInt(options[arrayKeys[i]], 10);\n                        if (!isNaN(val) && unitSeconds[arrayKeys[i]]) {\n                            timestamp += val * unitSeconds[arrayKeys[i]];\n                        }\n                    }\n                }\n\n                /**\n                 * Update a single counter element in the DOM.\n                 *\n                 * @param {string} counter The unit name (e.g. 'hours').\n                 * @param {number} time The value to display.\n                 */\n                function updateMainCounter(counter, time) {\n                    var html = '';\n                    if (forceTwoDigits === true && time.toString().length == 1) {\n                        html += '<span class=\"timerNumChar\" data-id=\"0\">0</span>';\n                        html += '<span class=\"timerNumChar\" data-id=\"1\">' + time.toString() + '</span>';\n                    } else {\n                        for (var i = 0; i < time.toString().length; i++) {\n                            html += '<span class=\"timerNumChar\" data-id=\"' + i + '\">' +\n                                time.toString().charAt(i) + '</span>';\n                        }\n                    }\n\n                    $('.block_enrolmenttimer .active .timer-wrapper .timerNum[data-id=\"' + counter + '\"]').html(html);\n                    $('.block_enrolmenttimer .active .text-desc .' + counter).html(time);\n                }\n\n                /**\n                 * Decrement the timestamp and update all displayed counters.\n                 */\n                function updateLiveCounter() {\n                    if (timestamp <= 0) {\n                        if (intervalId !== null) {\n                            window.clearInterval(intervalId);\n                            intervalId = null;\n                        }\n                        for (var j = 0; j < arrayKeys.length; j++) {\n                            updateMainCounter(arrayKeys[j], 0);\n                        }\n                        return;\n                    }\n\n                    timestamp--;\n                    var time = timestamp;\n                    var tokens = ['years', 'months', 'weeks', 'days', 'hours', 'minutes', 'seconds'];\n                    var units = [31536000, 2592000, 604800, 86400, 3600, 60, 1];\n\n                    for (var i = 0; i < tokens.length; i++) {\n                        if (arrayKeys.indexOf(tokens[i]) != -1) {\n                            if (time >= units[i]) {\n                                var count = Math.floor(time / units[i]);\n                                updateMainCounter(tokens[i], count);\n                                time = time - (count * units[i]);\n                            } else {\n                                updateMainCounter(tokens[i], 0);\n                            }\n                        }\n                    }\n                }\n\n                if ($('.block_enrolmenttimer .active').length > 0) {\n                    if ($('.block_enrolmenttimer .timer-wrapper[data-id=force2]').length > 0) {\n                        forceTwoDigits = true;\n                    }\n\n                    getDisplayedOptions();\n                    populateWithData();\n                    makeTimestamp();\n\n                    intervalId = window.setInterval(function() {\n                        updateLiveCounter();\n                    }, 1000);\n                }\n            });\n        }\n    };\n});\n"],"names":["define","$","initialise","document","ready","options","arrayKeys","timestamp","forceTwoDigits","intervalId","updateMainCounter","counter","time","html","toString","length","i","charAt","children","find","arrayKey","attr","push","getDisplayedOptions","option","text","populateWithData","unitSeconds","val","parseInt","isNaN","makeTimestamp","window","setInterval","clearInterval","j","tokens","units","indexOf","count","Math","floor","updateLiveCounter"],"mappings":";;;;;;;;AAuBAA,sCAAO,CAAC,WAAW,SAASC,SAEjB,CAIHC,WAAY,WACRD,EAAEE,UAAUC,OAAM,eACVC,QAAU,GACVC,UAAY,GACZC,UAAY,EACZC,gBAAiB,EACjBC,WAAa,cAoDRC,kBAAkBC,QAASC,UAC5BC,KAAO,OACY,IAAnBL,gBAAqD,GAA1BI,KAAKE,WAAWC,OAC3CF,MAAQ,kDACRA,MAAQ,0CAA4CD,KAAKE,WAAa,mBAEjE,IAAIE,EAAI,EAAGA,EAAIJ,KAAKE,WAAWC,OAAQC,IACxCH,MAAQ,uCAAyCG,EAAI,KACjDJ,KAAKE,WAAWG,OAAOD,GAAK,UAIxCf,EAAE,mEAAqEU,QAAU,MAAME,KAAKA,MAC5FZ,EAAE,6CAA+CU,SAASE,KAAKD,MAoC/DX,EAAE,iCAAiCc,OAAS,IACxCd,EAAE,wDAAwDc,OAAS,IACnEP,gBAAiB,sBAjGjBU,SAAWjB,EAAE,gDAAgDkB,KAAK,aAE7DH,EAAIE,SAASH,OAAS,EAAGC,GAAK,EAAGA,IAAK,KACvCI,SAAWnB,EAAEiB,SAASF,IAAIK,KAAK,WACnCf,UAAUgB,KAAKF,WAgGnBG,kBAxFK,IAAIP,EAAIV,UAAUS,OAAS,EAAGC,GAAK,EAAGA,IAAK,KACxCQ,OAASvB,EAAE,6CAA+CK,UAAUU,IAAIS,OAC5EpB,QAAQC,UAAUU,IAAMQ,QAuF5BE,sBA/EIC,YAAc,SACH,UACA,SACF,UACD,YACC,cACC,aACD,SAGJX,EAAI,EAAGA,EAAIV,UAAUS,OAAQC,IAAK,KACnCY,IAAMC,SAASxB,QAAQC,UAAUU,IAAK,KACrCc,MAAMF,MAAQD,YAAYrB,UAAUU,MACrCT,WAAaqB,IAAMD,YAAYrB,UAAUU,MAmEjDe,GAEAtB,WAAauB,OAAOC,aAAY,0BAtC5B1B,WAAa,GACM,OAAfE,aACAuB,OAAOE,cAAczB,YACrBA,WAAa,UAEZ,IAAI0B,EAAI,EAAGA,EAAI7B,UAAUS,OAAQoB,IAClCzB,kBAAkBJ,UAAU6B,GAAI,gBAMpCvB,OADJL,UAEI6B,OAAS,CAAC,QAAS,SAAU,QAAS,OAAQ,QAAS,UAAW,WAClEC,MAAQ,CAAC,QAAU,OAAS,OAAQ,MAAO,KAAM,GAAI,GAEhDrB,EAAI,EAAGA,EAAIoB,OAAOrB,OAAQC,QACM,GAAjCV,UAAUgC,QAAQF,OAAOpB,OACrBJ,MAAQyB,MAAMrB,GAAI,KACduB,MAAQC,KAAKC,MAAM7B,KAAOyB,MAAMrB,IACpCN,kBAAkB0B,OAAOpB,GAAIuB,OAC7B3B,MAAe2B,MAAQF,MAAMrB,QAE7BN,kBAAkB0B,OAAOpB,GAAI,GAgBrC0B,KACD"}